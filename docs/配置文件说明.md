# OpenChatBI é…ç½®æ–‡ä»¶è¯¦ç»†è¯´æ˜

## ğŸ¤” æ ¸å¿ƒé—®é¢˜é“¾ï¼ˆè‹æ ¼æ‹‰åº•æ€ç»´ï¼‰

**é—®é¢˜1ï¼šè¿™ä¸ªç¨‹åºè¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ**  
â†’ å°†è‡ªç„¶è¯­è¨€è½¬æ¢ä¸ºSQLæŸ¥è¯¢ï¼Œéœ€è¦ç†è§£æ•°æ®åº“ç»“æ„å’Œä¸šåŠ¡è¯­ä¹‰

**é—®é¢˜2ï¼šç¨‹åºå¦‚ä½•çŸ¥é“æ•°æ®åº“ç»“æ„ï¼Ÿ**  
â†’ é€šè¿‡æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨çš„ç›®å½•ï¼ˆcatalogï¼‰æ¥ç®¡ç†è¡¨ç»“æ„ã€å­—æ®µä¿¡æ¯

**é—®é¢˜3ï¼šä»…æœ‰ç»“æ„ä¿¡æ¯å¤Ÿå—ï¼Ÿ**  
â†’ ä¸å¤Ÿï¼Œè¿˜éœ€è¦ä¸šåŠ¡è¯­ä¹‰ã€ç¤ºä¾‹ã€è§„åˆ™ç­‰è¾…åŠ©ä¿¡æ¯

**é—®é¢˜4ï¼šå¦‚ä½•ç»„ç»‡è¿™äº›ä¿¡æ¯ï¼Ÿ**  
â†’ ä½¿ç”¨ YAML å’Œ CSV æ–‡ä»¶åˆ†åˆ«å­˜å‚¨ä¸åŒç±»å‹çš„å…ƒæ•°æ®

---

## ğŸ“‹ å¿…éœ€çš„é…ç½®æ–‡ä»¶æ¸…å•

åŸºäº `file_system.py` çš„å®ç°ï¼Œéœ€è¦å‡†å¤‡ä»¥ä¸‹æ–‡ä»¶ï¼š

### **1. table_info.yaml** â­â­â­â­â­

**ç”¨é€”ï¼š** å­˜å‚¨è¡¨çš„ä¸šåŠ¡æè¿°å’ŒSQLç”Ÿæˆè§„åˆ™  
**ä½ç½®ï¼š** `{data_path}/table_info.yaml`  
**ç»“æ„ï¼š**

```yaml
æ•°æ®åº“å:
  è¡¨å1:
    description: è¡¨çš„ä¸šåŠ¡æè¿°
    selection_rule: ä½•æ—¶é€‰æ‹©è¿™ä¸ªè¡¨çš„è§„åˆ™
    sql_rule: ç”ŸæˆSQLæ—¶çš„æ³¨æ„äº‹é¡¹
  è¡¨å2:
    description: ...
    selection_rule: ...
    sql_rule: ...
```

**è¯¦ç»†ç¤ºä¾‹ï¼š**

```yaml
'':  # ç©ºå­—ç¬¦ä¸²ä»£è¡¨é»˜è®¤æ•°æ®åº“
  orders:
    description: 'è®¢å•ä¸»è¡¨ï¼ŒåŒ…å«è®¢å•çŠ¶æ€ã€ä¸‹å•æ—¥æœŸå’Œå®¢æˆ·å…³è”ä¿¡æ¯'
    selection_rule: 'å½“æŸ¥è¯¢æ¶‰åŠè®¢å•çŠ¶æ€ã€è®¢å•å†å²æˆ–å®¢æˆ·è®¢å•å…³ç³»æ—¶é€‰æ‹©æ­¤è¡¨'
    sql_rule: 'ä½¿ç”¨ order_id ä½œä¸ºä¸»é”®ã€‚é€šè¿‡ customer_id ä¸ Customers è¡¨å…³è”è·å–å®¢æˆ·ä¿¡æ¯'
  
  customers:
    description: 'å®¢æˆ·ä¿¡æ¯è¡¨ï¼ŒåŒ…å«å®¢æˆ·IDã€å§“åå’Œè¯¦ç»†ä¿¡æ¯'
    selection_rule: 'å½“æŸ¥è¯¢æ¶‰åŠå®¢æˆ·ä¿¡æ¯ã€å®¢æˆ·å§“åæˆ–éœ€è¦å°†è®¢å•ä¸å®¢æˆ·æ•°æ®å…³è”æ—¶é€‰æ‹©'
    sql_rule: 'ä½¿ç”¨ customer_id ä½œä¸ºä¸»é”®è¿›è¡Œå…³è”ã€‚æ˜¾ç¤ºå®¢æˆ·ä¿¡æ¯æ—¶å§‹ç»ˆåŒ…å« customer_name'
  
  products:
    description: 'äº§å“ç›®å½•ï¼ŒåŒ…å«äº§å“åç§°ã€IDå’Œè¯¦ç»†äº§å“ä¿¡æ¯'
    selection_rule: 'å½“æŸ¥è¯¢æ¶‰åŠäº§å“ä¿¡æ¯ã€äº§å“æœç´¢æˆ–åº“å­˜ç›¸å…³é—®é¢˜æ—¶é€‰æ‹©'
    sql_rule: 'ä½¿ç”¨ product_id ä½œä¸ºä¸»é”®ã€‚å¯¹ product_name è¿›è¡Œæœç´¢æ—¶ä½¿ç”¨ LIKE æ“ä½œç¬¦'

sdtm:  # ä¸´åºŠè¯•éªŒæ•°æ®åº“ç¤ºä¾‹
  dm:
    description: 'å—è¯•è€…çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¹´é¾„ã€æ€§åˆ«ã€ç§æ—ã€å…¥ç»„æ—¥æœŸã€æ²»ç–—åˆ†ç»„ç­‰'
    selection_rule: 'å½“æŸ¥è¯¢å—è¯•è€…åŸºæœ¬ç‰¹å¾ã€äººå£ç»Ÿè®¡å­¦ä¿¡æ¯æˆ–åˆ†ç»„ä¿¡æ¯æ—¶é€‰æ‹©'
    sql_rule: 'USUBJID æ˜¯å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¯ç”¨äºä¸å…¶ä»–åŸŸå…³è”'
  
  ae:
    description: 'è®°å½•ç ”ç©¶æœŸé—´å‘ç”Ÿçš„æ‰€æœ‰ä¸è‰¯äº‹ä»¶ï¼ŒåŒ…æ‹¬ç—‡çŠ¶ã€ä¸¥é‡ç¨‹åº¦ã€å› æœå…³ç³»ç­‰'
    selection_rule: 'å½“æŸ¥è¯¢å®‰å…¨æ€§ç›¸å…³é—®é¢˜ã€ä¸è‰¯ååº”æˆ–å‰¯ä½œç”¨æ—¶é€‰æ‹©'
    sql_rule: 'é€šè¿‡ USUBJID ä¸ dm è¡¨å…³è”è·å–å—è¯•è€…ä¿¡æ¯ã€‚AESER=Y è¡¨ç¤ºä¸¥é‡ä¸è‰¯äº‹ä»¶'
```

---

### **2. common_columns.csv** â­â­â­â­â­

**ç”¨é€”ï¼š** å®šä¹‰è·¨å¤šä¸ªè¡¨é€šç”¨çš„å­—æ®µè¯¦ç»†ä¿¡æ¯  
**ä½ç½®ï¼š** `{data_path}/common_columns.csv`  
**ä½œç”¨ï¼š** é¿å…é‡å¤å®šä¹‰ç›¸åŒå­—æ®µï¼Œç»Ÿä¸€ç®¡ç†å…¬å…±å­—æ®µçš„ä¸šåŠ¡å«ä¹‰

**å­—æ®µè¯´æ˜ï¼š**
- `column_name`: å­—æ®µåï¼ˆå¿…éœ€ï¼‰
- `display_name`: æ˜¾ç¤ºåç§°ï¼ˆä¸­æ–‡/å‹å¥½åç§°ï¼‰
- `alias`: åˆ«åï¼ˆSQLä¸­å¯ç”¨çš„ç®€å†™ï¼‰
- `type`: æ•°æ®ç±»å‹ï¼ˆå¿…éœ€ï¼‰
- `category`: ç±»åˆ«ï¼ˆidentifier/attribute/temporal/statusç­‰ï¼‰
- `tag`: æ ‡ç­¾ï¼ˆç”¨äºåˆ†ç»„ï¼Œå¦‚customer/order/productï¼‰
- `description`: ä¸šåŠ¡æè¿°
- `dimension_table`: ç»´åº¦è¡¨ï¼ˆå¦‚æœæ˜¯å¤–é”®ï¼‰
- `default`: é»˜è®¤å€¼

**è¯¦ç»†ç¤ºä¾‹ï¼š**

```csv
column_name,display_name,alias,type,category,tag,description,dimension_table,default
order_id,è®¢å•ID,ord_id,INTEGER,identifier,order,è®¢å•çš„å”¯ä¸€æ ‡è¯†ç¬¦,Orders,
customer_id,å®¢æˆ·ID,cust_id,INTEGER,identifier,customer,å®¢æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦,Customers,
product_id,äº§å“ID,prod_id,INTEGER,identifier,product,äº§å“çš„å”¯ä¸€æ ‡è¯†ç¬¦,Products,
order_status,è®¢å•çŠ¶æ€,ord_status,VARCHAR(20),status,order,è®¢å•å½“å‰çŠ¶æ€(å·²å‘è´§|æ‰“åŒ…ä¸­|è¿è¾“ä¸­),Orders,
customer_name,å®¢æˆ·å§“å,cust_name,VARCHAR(100),attribute,customer,å®¢æˆ·çš„å§“å,Customers,
product_name,äº§å“åç§°,prod_name,VARCHAR(200),attribute,product,äº§å“çš„åç§°,Products,
order_date,ä¸‹å•æ—¥æœŸ,ord_date,DATE,temporal,order,è®¢å•åˆ›å»ºçš„æ—¥æœŸ,Orders,
price,ä»·æ ¼,price,DECIMAL(10,2),metric,financial,ä»·æ ¼é‡‘é¢,,
quantity,æ•°é‡,qty,INTEGER,metric,inventory,å•†å“æ•°é‡,,
created_at,åˆ›å»ºæ—¶é—´,created,TIMESTAMP,temporal,system,è®°å½•åˆ›å»ºæ—¶é—´,,CURRENT_TIMESTAMP
updated_at,æ›´æ–°æ—¶é—´,updated,TIMESTAMP,temporal,system,è®°å½•æœ€åæ›´æ–°æ—¶é—´,,CURRENT_TIMESTAMP
```

---

### **3. table_columns.csv** â­â­â­â­â­

**ç”¨é€”ï¼š** å®šä¹‰å“ªäº›è¡¨åŒ…å«å“ªäº›å­—æ®µï¼ˆè¡¨-å­—æ®µæ˜ å°„å…³ç³»ï¼‰  
**ä½ç½®ï¼š** `{data_path}/table_columns.csv`  
**ä½œç”¨ï¼š** å»ºç«‹è¡¨ä¸å­—æ®µçš„å…³è”ï¼Œæ˜¯æ„å»ºæ•°æ®ç›®å½•çš„åŸºç¡€

**å­—æ®µè¯´æ˜ï¼š**
- `db_name`: æ•°æ®åº“å
- `table_name`: è¡¨å
- `column_name`: å­—æ®µå

**è¯¦ç»†ç¤ºä¾‹ï¼š**

```csv
db_name,table_name,column_name
,orders,order_id
,orders,customer_id
,orders,order_status
,orders,order_date
,orders,total_amount
,customers,customer_id
,customers,customer_name
,customers,email
,customers,phone
,customers,address
,products,product_id
,products,product_name
,products,category
,products,price
,products,stock_quantity
,order_items,order_item_id
,order_items,order_id
,order_items,product_id
,order_items,quantity
,order_items,unit_price
sdtm,dm,STUDYID
sdtm,dm,USUBJID
sdtm,dm,AGE
sdtm,dm,SEX
sdtm,dm,RACE
sdtm,ae,STUDYID
sdtm,ae,USUBJID
sdtm,ae,AETERM
sdtm,ae,AESEV
sdtm,ae,AESER
```

---

### **4. sql_example.yaml** â­â­â­â­

**ç”¨é€”ï¼š** æä¾›å…¸å‹é—®é¢˜å’Œå¯¹åº”SQLçš„ç¤ºä¾‹ï¼ˆFew-shot learningï¼‰  
**ä½ç½®ï¼š** `{data_path}/sql_example.yaml`  
**ä½œç”¨ï¼š** å¸®åŠ©LLMå­¦ä¹ å¦‚ä½•ä¸ºç‰¹å®šè¡¨ç”Ÿæˆæ­£ç¡®çš„SQLè¯­å¥

**ç»“æ„ï¼š**

```yaml
æ•°æ®åº“å:
  è¡¨å: |
    Q: é—®é¢˜1
    A: SQLè¯­å¥1
    
    Q: é—®é¢˜2
    A: SQLè¯­å¥2
```

**è¯¦ç»†ç¤ºä¾‹ï¼š**

```yaml
'':
  orders: |
    Q: æ˜¾ç¤ºæ‰€æœ‰å¾…å¤„ç†è®¢å•åŠå®¢æˆ·ä¿¡æ¯
    A: SELECT o.order_id, c.customer_name, o.order_status, o.order_date 
    FROM orders o 
    JOIN customers c ON o.customer_id = c.customer_id 
    WHERE o.order_status = 'å¾…å¤„ç†' 
    ORDER BY o.order_date DESC
    
    Q: ç»Ÿè®¡æ¯ä¸ªå®¢æˆ·çš„è®¢å•æ€»æ•°
    A: SELECT c.customer_name, COUNT(o.order_id) as order_count 
    FROM customers c 
    LEFT JOIN orders o ON c.customer_id = o.customer_id 
    GROUP BY c.customer_id, c.customer_name 
    ORDER BY order_count DESC
  
  products: |
    Q: æŸ¥æ‰¾åç§°åŒ…å«"ç¬”è®°æœ¬"çš„æ‰€æœ‰äº§å“
    A: SELECT product_id, product_name, price, stock_quantity 
    FROM products 
    WHERE product_name LIKE '%ç¬”è®°æœ¬%' 
    ORDER BY product_name
    
    Q: æ˜¾ç¤ºåº“å­˜ä½äº10çš„äº§å“
    A: SELECT product_id, product_name, stock_quantity 
    FROM products 
    WHERE stock_quantity < 10 
    ORDER BY stock_quantity ASC
  
  order_items: |
    Q: æ˜¾ç¤ºè®¢å•123ä¸­çš„æ‰€æœ‰å•†å“
    A: SELECT oi.order_item_id, p.product_name, oi.quantity, oi.unit_price 
    FROM order_items oi 
    JOIN products p ON oi.product_id = p.product_id 
    WHERE oi.order_id = 123

sdtm:
  dm: |
    Q: ç»Ÿè®¡ä¸åŒæ€§åˆ«çš„å—è¯•è€…äººæ•°
    A: SELECT SEX as æ€§åˆ«, COUNT(*) as äººæ•° 
    FROM dm 
    GROUP BY SEX
    
    Q: æŸ¥æ‰¾å¹´é¾„å¤§äº60å²çš„å—è¯•è€…
    A: SELECT USUBJID, AGE, SEX, ARM 
    FROM dm 
    WHERE AGE > 60 
    ORDER BY AGE DESC
  
  ae: |
    Q: ç»Ÿè®¡ä¸¥é‡ä¸è‰¯äº‹ä»¶çš„æ•°é‡
    A: SELECT COUNT(*) as ä¸¥é‡AEæ•°é‡ 
    FROM ae 
    WHERE AESER = 'Y'
    
    Q: æŒ‰ä¸¥é‡ç¨‹åº¦ç»Ÿè®¡ä¸è‰¯äº‹ä»¶
    A: SELECT AESEV as ä¸¥é‡ç¨‹åº¦, COUNT(*) as äº‹ä»¶æ•° 
    FROM ae 
    GROUP BY AESEV 
    ORDER BY äº‹ä»¶æ•° DESC
```

---

### **5. table_selection_example.csv** â­â­â­

**ç”¨é€”ï¼š** è®­ç»ƒè¡¨é€‰æ‹©æ¨¡å‹ï¼Œæ•™ä¼šç³»ç»Ÿæ ¹æ®é—®é¢˜é€‰æ‹©æ­£ç¡®çš„è¡¨  
**ä½ç½®ï¼š** `{data_path}/table_selection_example.csv`  
**ä½œç”¨ï¼š** åœ¨å¤æ‚æŸ¥è¯¢ä¸­å¸®åŠ©ç³»ç»Ÿåˆ¤æ–­éœ€è¦å…³è”å“ªäº›è¡¨

**å­—æ®µè¯´æ˜ï¼š**
- `question`: ç”¨æˆ·é—®é¢˜
- `selected_tables`: éœ€è¦ç”¨åˆ°çš„è¡¨åˆ—è¡¨ï¼ˆJSONæ•°ç»„æ ¼å¼æˆ–é€—å·åˆ†éš”ï¼‰

**è¯¦ç»†ç¤ºä¾‹ï¼š**

```csv
question,selected_tables
"æ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·","[""customers""]"
"ä»Šå¤©ä¸‹äº†å“ªäº›è®¢å•ï¼Ÿ","[""orders""]"
"åˆ—å‡ºæ‰€æœ‰äº§å“åŠå…¶è¯¦ç»†ä¿¡æ¯","[""products""]"
"æ˜¾ç¤ºå®¢æˆ·è®¢å•åŠå…¶è¯¦ç»†ä¿¡æ¯","[""customers"", ""orders""]"
"æ¯ä¸ªè®¢å•ä¸­æœ‰å“ªäº›äº§å“ï¼Ÿ","[""orders"", ""order_items"", ""products""]"
"æ˜¾ç¤ºè®¢å•çŠ¶æ€å’Œå®¢æˆ·ä¿¡æ¯","[""orders"", ""customers""]"
"æŸ¥è¯¢åº“å­˜ä¸è¶³çš„äº§å“è®¢å•æƒ…å†µ","[""products"", ""order_items"", ""orders""]"
"ç»Ÿè®¡æ¯ä¸ªå®¢æˆ·çš„æ€»æ¶ˆè´¹é‡‘é¢","[""customers"", ""orders"", ""order_items""]"
"æ˜¾ç¤ºè®¢å•çš„å®Œæ•´é…é€é“¾è·¯","[""orders"", ""order_items"", ""products"", ""customers""]"
"å“ªäº›å®¢æˆ·è´­ä¹°è¿‡ç¬”è®°æœ¬ç”µè„‘ï¼Ÿ","[""customers"", ""orders"", ""order_items"", ""products""]"
"æŸ¥æ‰¾é‡åº¦ä¸è‰¯äº‹ä»¶çš„å—è¯•è€…ç‰¹å¾","[""ae"", ""dm""]"
"ç»Ÿè®¡æ²»ç–—ç»„çš„ä¸è‰¯äº‹ä»¶å‘ç”Ÿç‡","[""dm"", ""ae""]"
"æŒ‰å¹´é¾„æ®µåˆ†æä¸è‰¯äº‹ä»¶åˆ†å¸ƒ","[""dm"", ""ae""]"
"æ˜¾ç¤ºå—è¯•è€…çš„ç”Ÿå‘½ä½“å¾è¶‹åŠ¿","[""dm"", ""vs""]"
```

---

### **6. table_spec_columns.csv** â­â­â­ (å¯é€‰)

**ç”¨é€”ï¼š** å®šä¹‰ç‰¹å®šè¡¨ç‹¬æœ‰çš„å­—æ®µè¯¦ç»†ä¿¡æ¯ï¼ˆè¦†ç›–common_columnsï¼‰  
**ä½ç½®ï¼š** `{data_path}/table_spec_columns.csv`  
**ä½œç”¨ï¼š** å½“æŸä¸ªè¡¨ä¸­çš„å­—æ®µéœ€è¦ç‰¹æ®Šè¯´æ˜æ—¶ä½¿ç”¨

**è¯¦ç»†ç¤ºä¾‹ï¼š**

```csv
db_name,table_name,column_name,display_name,alias,type,category,tag,description
,orders,status,è®¢å•çŠ¶æ€,ord_status,VARCHAR(20),status,order,è®¢å•ç‰¹å®šçŠ¶æ€ï¼šæ–°å»º|å·²æ”¯ä»˜|å·²å‘è´§|å·²å®Œæˆ|å·²å–æ¶ˆ
,shipments,status,å‘è´§çŠ¶æ€,ship_status,VARCHAR(20),status,shipment,å‘è´§ç‰¹å®šçŠ¶æ€ï¼šå¾…å‘è´§|è¿è¾“ä¸­|å·²ç­¾æ”¶|é€€å›
sdtm,ae,AESEV,ä¸¥é‡ç¨‹åº¦,severity,VARCHAR(20),status,safety,ä¸è‰¯äº‹ä»¶ä¸¥é‡ç¨‹åº¦ï¼šMILD(è½»åº¦)|MODERATE(ä¸­åº¦)|SEVERE(é‡åº¦)
```

---

## ğŸ¯ æ–‡ä»¶ä¼˜å…ˆçº§å’Œä¾èµ–å…³ç³»

### å¿…éœ€æ–‡ä»¶ï¼ˆâ­â­â­â­â­ï¼‰
1. **table_columns.csv** - åŸºç¡€ï¼Œå®šä¹‰è¡¨ç»“æ„
2. **common_columns.csv** - å­—æ®µè¯­ä¹‰
3. **table_info.yaml** - ä¸šåŠ¡æè¿°å’Œè§„åˆ™

### å¼ºçƒˆæ¨èï¼ˆâ­â­â­â­ï¼‰
4. **sql_example.yaml** - æå‡SQLç”Ÿæˆè´¨é‡

### å¯é€‰å¢å¼ºï¼ˆâ­â­â­ï¼‰
5. **table_selection_example.csv** - æ”¹å–„å¤šè¡¨æŸ¥è¯¢
6. **table_spec_columns.csv** - å¤„ç†ç‰¹æ®Šå­—æ®µ

---

## ğŸ’¡ å‡†å¤‡å»ºè®®

### æœ€å°å¯åŠ¨é…ç½®

```
data_path/
â”œâ”€â”€ table_columns.csv        # å¿…éœ€ï¼šè¡¨-å­—æ®µæ˜ å°„
â”œâ”€â”€ common_columns.csv        # å¿…éœ€ï¼šå­—æ®µå®šä¹‰
â””â”€â”€ table_info.yaml           # å¿…éœ€ï¼šè¡¨æè¿°
```

### å®Œæ•´ç”Ÿäº§é…ç½®

```
data_path/
â”œâ”€â”€ table_columns.csv         # è¡¨-å­—æ®µæ˜ å°„
â”œâ”€â”€ common_columns.csv        # é€šç”¨å­—æ®µå®šä¹‰
â”œâ”€â”€ table_spec_columns.csv    # ç‰¹æ®Šå­—æ®µå®šä¹‰
â”œâ”€â”€ table_info.yaml           # è¡¨ä¸šåŠ¡æè¿°
â”œâ”€â”€ sql_example.yaml          # SQLç¤ºä¾‹
â””â”€â”€ table_selection_example.csv  # è¡¨é€‰æ‹©ç¤ºä¾‹
```

---

## ğŸ” å·¥ä½œåŸç†è§£æ

### æ–‡ä»¶åŠ è½½æµç¨‹

1. **åˆå§‹åŒ–é˜¶æ®µ** (`__init__`)
   - è®¾ç½®æ–‡ä»¶è·¯å¾„
   - åˆ›å»ºæ•°æ®ç›®å½•
   - åˆå§‹åŒ–ç¼“å­˜

2. **é¦–æ¬¡è®¿é—®æ—¶åŠ è½½** (æ‡’åŠ è½½æ¨¡å¼)
   - `_load_yaml_file()`: åŠ è½½ YAML æ–‡ä»¶
   - `_load_csv_file()`: åŠ è½½ CSV æ–‡ä»¶
   - æ•°æ®å­˜å…¥ç¼“å­˜ä»¥æé«˜æ€§èƒ½

3. **æ•°æ®è®¿é—®æ¥å£**
   - `get_table_list()`: è·å–è¡¨åˆ—è¡¨
   - `get_column_list()`: è·å–å­—æ®µåˆ—è¡¨
   - `get_table_information()`: è·å–è¡¨æè¿°
   - `get_sql_examples()`: è·å–SQLç¤ºä¾‹
   - `get_table_selection_examples()`: è·å–è¡¨é€‰æ‹©ç¤ºä¾‹

### ç¼“å­˜æœºåˆ¶

æ‰€æœ‰æ–‡ä»¶è¯»å–åä¼šç¼“å­˜åœ¨å†…å­˜ä¸­ï¼š
- `_table_info_cache`: è¡¨ä¿¡æ¯ç¼“å­˜
- `_table_columns_cache`: è¡¨å­—æ®µç¼“å­˜
- `_common_columns_cache`: å…¬å…±å­—æ®µç¼“å­˜
- `_sql_example_cache`: SQLç¤ºä¾‹ç¼“å­˜
- `_table_selection_example_cache`: è¡¨é€‰æ‹©ç¤ºä¾‹ç¼“å­˜

å½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œè°ƒç”¨ `_clear_cache()` æ¸…é™¤ç¼“å­˜ç¡®ä¿ä¸€è‡´æ€§ã€‚

### å­—æ®µä¼˜å…ˆçº§

å½“è·å–å­—æ®µä¿¡æ¯æ—¶ï¼Œä¼˜å…ˆçº§é¡ºåºï¼š
1. **table_spec_columns.csv** - è¡¨ç‰¹å®šå­—æ®µï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. **common_columns.csv** - é€šç”¨å­—æ®µï¼ˆé»˜è®¤ï¼‰

è¿™ç§è®¾è®¡å…è®¸ä¸ºç‰¹å®šè¡¨çš„å­—æ®µæä¾›ä¸“é—¨çš„ä¸šåŠ¡æè¿°ï¼ŒåŒæ—¶ä¿æŒå¤§éƒ¨åˆ†å­—æ®µå®šä¹‰çš„å¤ç”¨æ€§ã€‚

---

## ğŸ“ å®è·µå»ºè®®

### 1. ä»æ•°æ®åº“è‡ªåŠ¨ç”ŸæˆåŸºç¡€æ–‡ä»¶

ä½¿ç”¨ `DataCatalogLoader` ç±»å¯ä»¥ä»å®é™…æ•°æ®åº“ä¸­è‡ªåŠ¨æå–è¡¨ç»“æ„ï¼š

```python
from openchatbi.catalog.catalog_loader import DataCatalogLoader
from openchatbi.catalog.factory import create_catalog_store

# è¿æ¥æ•°æ®åº“
engine = create_sqlalchemy_engine(database_uri)
loader = DataCatalogLoader(engine)

# åŠ è½½åˆ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨
catalog_store = create_catalog_store('file_system', data_path)
loader.load_catalog_to_store(catalog_store)
```

è¿™ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š
- `table_columns.csv` - ä»æ•°æ®åº“schemaæå–
- `common_columns.csv` - åŸºç¡€å­—æ®µä¿¡æ¯
- `table_info.yaml` - ç©ºç™½æ¨¡æ¿

### 2. ä»æœ¬åœ°æ–‡ä»¶ï¼ˆCSV/Excelç­‰ï¼‰ç”ŸæˆåŸºç¡€æ–‡ä»¶

**åœºæ™¯ï¼š** å½“æ•°æ®å­˜æ”¾åœ¨CSVã€Excelç­‰æ–‡ä»¶ä¸­ï¼Œè€Œä¸æ˜¯æ•°æ®åº“æ—¶

#### æ–¹æ³•ä¸€ï¼šå…ˆå¯¼å…¥SQLiteå†ç”Ÿæˆé…ç½®

è¿™æ˜¯æœ€ç®€å•çš„æ–¹æ³•ï¼Œåˆ©ç”¨SQLiteä½œä¸ºä¸­é—´å±‚ï¼š

```python
"""å°†CSVæ–‡ä»¶å¯¼å…¥SQLiteå¹¶ç”Ÿæˆcatalogé…ç½®æ–‡ä»¶"""
import pandas as pd
import sqlite3
from pathlib import Path
from sqlalchemy import create_engine
from openchatbi.catalog.catalog_loader import DataCatalogLoader
from openchatbi.catalog.factory import create_catalog_store

# æ­¥éª¤1: å®šä¹‰CSVæ–‡ä»¶æ˜ å°„
CSV_FILES = {
    "customers": "data/customers.csv",
    "orders": "data/orders.csv", 
    "products": "data/products.csv",
}

DB_PATH = "data/my_business.db"

# æ­¥éª¤2: å°†CSVå¯¼å…¥SQLite
print("æ­£åœ¨å°†CSVæ–‡ä»¶å¯¼å…¥SQLite...")
db_path = Path(DB_PATH)
db_path.parent.mkdir(parents=True, exist_ok=True)

conn = sqlite3.connect(DB_PATH)
for table_name, csv_path in CSV_FILES.items():
    print(f"  åŠ è½½ {csv_path} -> {table_name}")
    df = pd.read_csv(csv_path)
    df.to_sql(table_name, conn, if_exists='replace', index=False)
    print(f"    âœ“ {len(df)} è¡Œæ•°æ®")
conn.close()

# æ­¥éª¤3: ä»SQLiteè‡ªåŠ¨ç”Ÿæˆcatalogé…ç½®
print("\næ­£åœ¨ç”Ÿæˆcatalogé…ç½®æ–‡ä»¶...")
engine = create_engine(f"sqlite:///{DB_PATH}")
loader = DataCatalogLoader(engine)

# åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ï¼ˆé…ç½®æ–‡ä»¶ä¿å­˜ç›®å½•ï¼‰
catalog_store = create_catalog_store(
    'file_system',
    data_path='./catalog_config'  # é…ç½®æ–‡ä»¶ä¿å­˜ä½ç½®
)

# è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶
loader.save_to_catalog_store(catalog_store, database_name='')

print("\nâœ“ é…ç½®æ–‡ä»¶å·²ç”Ÿæˆåˆ° ./catalog_config/ ç›®å½•")
print("  - table_columns.csv")
print("  - common_columns.csv")
print("  - table_info.yaml")
```

**è¿è¡Œåç›®å½•ç»“æ„ï¼š**
```
project/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ customers.csv          # åŸå§‹CSVæ–‡ä»¶
â”‚   â”œâ”€â”€ orders.csv
â”‚   â”œâ”€â”€ products.csv
â”‚   â””â”€â”€ my_business.db         # ç”Ÿæˆçš„SQLiteæ•°æ®åº“
â””â”€â”€ catalog_config/             # ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ç›®å½•
    â”œâ”€â”€ table_columns.csv
    â”œâ”€â”€ common_columns.csv
    â””â”€â”€ table_info.yaml
```

#### æ–¹æ³•äºŒï¼šç›´æ¥ä»DataFrameç”Ÿæˆé…ç½®

å¦‚æœæƒ³è·³è¿‡SQLiteï¼Œç›´æ¥ä»pandas DataFrameç”Ÿæˆé…ç½®ï¼š

```python
"""ç›´æ¥ä»CSVæ–‡ä»¶åˆ†æç”Ÿæˆcatalogé…ç½®"""
import pandas as pd
import csv
import yaml
from pathlib import Path
from collections import defaultdict

def generate_catalog_from_csv(csv_files: dict, output_dir: str):
    """
    ä»CSVæ–‡ä»¶ç”Ÿæˆcatalogé…ç½®æ–‡ä»¶
    
    Args:
        csv_files: {è¡¨å: CSVè·¯å¾„} å­—å…¸
        output_dir: é…ç½®æ–‡ä»¶è¾“å‡ºç›®å½•
    """
    output_path = Path(output_dir)
    output_path.mkdir(parents=True, exist_ok=True)
    
    # å‡†å¤‡æ•°æ®ç»“æ„
    table_columns_data = []
    common_columns_dict = {}
    table_info = {'': {}}  # é»˜è®¤æ•°æ®åº“
    
    print("åˆ†æCSVæ–‡ä»¶ç»“æ„...")
    
    for table_name, csv_path in csv_files.items():
        print(f"\nå¤„ç†è¡¨: {table_name}")
        
        # è¯»å–CSVè·å–åˆ—ä¿¡æ¯
        df = pd.read_csv(csv_path, nrows=5)  # åªè¯»å°‘é‡è¡Œç”¨äºåˆ†æ
        
        # ç”Ÿæˆtable_columns.csvæ•°æ®
        for column_name in df.columns:
            table_columns_data.append({
                'db_name': '',
                'table_name': table_name,
                'column_name': column_name
            })
            print(f"  - {column_name}")
        
        # ç”Ÿæˆcommon_columns.csvæ•°æ®ï¼ˆæ¨æ–­æ•°æ®ç±»å‹ï¼‰
        for column_name, dtype in df.dtypes.items():
            if column_name not in common_columns_dict:
                # å°†pandasç±»å‹æ˜ å°„åˆ°SQLç±»å‹
                if pd.api.types.is_integer_dtype(dtype):
                    sql_type = 'INTEGER'
                elif pd.api.types.is_float_dtype(dtype):
                    sql_type = 'FLOAT'
                elif pd.api.types.is_datetime64_any_dtype(dtype):
                    sql_type = 'TIMESTAMP'
                else:
                    sql_type = 'VARCHAR(255)'
                
                common_columns_dict[column_name] = {
                    'column_name': column_name,
                    'display_name': '',  # å¾…æ‰‹åŠ¨å¡«å†™
                    'alias': '',
                    'type': sql_type,
                    'category': '',
                    'tag': '',
                    'description': '',  # å¾…æ‰‹åŠ¨å¡«å†™
                    'dimension_table': '',
                    'default': ''
                }
        
        # ç”Ÿæˆtable_info.yamlæ•°æ®ï¼ˆç©ºç™½æ¨¡æ¿ï¼‰
        table_info[''][table_name] = {
            'description': '',  # å¾…æ‰‹åŠ¨å¡«å†™
            'selection_rule': '',  # å¾…æ‰‹åŠ¨å¡«å†™
            'sql_rule': ''  # å¾…æ‰‹åŠ¨å¡«å†™
        }
    
    # ä¿å­˜table_columns.csv
    table_columns_file = output_path / 'table_columns.csv'
    with open(table_columns_file, 'w', encoding='utf-8', newline='') as f:
        writer = csv.DictWriter(f, fieldnames=['db_name', 'table_name', 'column_name'])
        writer.writeheader()
        writer.writerows(table_columns_data)
    print(f"\nâœ“ å·²ç”Ÿæˆ: {table_columns_file}")
    
    # ä¿å­˜common_columns.csv
    common_columns_file = output_path / 'common_columns.csv'
    with open(common_columns_file, 'w', encoding='utf-8', newline='') as f:
        fieldnames = ['column_name', 'display_name', 'alias', 'type', 
                     'category', 'tag', 'description', 'dimension_table', 'default']
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(common_columns_dict.values())
    print(f"âœ“ å·²ç”Ÿæˆ: {common_columns_file}")
    
    # ä¿å­˜table_info.yaml
    table_info_file = output_path / 'table_info.yaml'
    with open(table_info_file, 'w', encoding='utf-8') as f:
        yaml.dump(table_info, f, default_flow_style=False, allow_unicode=True)
    print(f"âœ“ å·²ç”Ÿæˆ: {table_info_file}")
    
    print(f"\n{'='*60}")
    print("é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼")
    print(f"è¾“å‡ºç›®å½•: {output_path.absolute()}")
    print(f"\nä¸‹ä¸€æ­¥:")
    print("1. ç¼–è¾‘ common_columns.csv å¡«å†™ä¸­æ–‡åç§°å’Œæè¿°")
    print("2. ç¼–è¾‘ table_info.yaml å¡«å†™è¡¨çš„ä¸šåŠ¡è¯´æ˜")
    print("3. åˆ›å»º sql_example.yaml æ·»åŠ SQLç¤ºä¾‹")
    print("4. åˆ›å»º table_selection_example.csv æ·»åŠ è¡¨é€‰æ‹©ç¤ºä¾‹")
    print("="*60)

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    CSV_FILES = {
        "customers": "data/customers.csv",
        "orders": "data/orders.csv",
        "products": "data/products.csv",
    }
    
    generate_catalog_from_csv(CSV_FILES, output_dir='./catalog_config')
```

#### æ–¹æ³•ä¸‰ï¼šExcelæ‰¹é‡é…ç½®

å¦‚æœä½ æœ‰å¤šä¸ªExcel sheetï¼Œæ¯ä¸ªsheetä»£è¡¨ä¸€å¼ è¡¨ï¼š

```python
"""ä»Excelæ–‡ä»¶ï¼ˆå¤šsheetï¼‰ç”Ÿæˆcatalogé…ç½®"""
import pandas as pd

def generate_catalog_from_excel(excel_file: str, output_dir: str):
    """
    ä»Excelæ–‡ä»¶çš„å¤šä¸ªsheetç”Ÿæˆcatalogé…ç½®
    
    Args:
        excel_file: Excelæ–‡ä»¶è·¯å¾„
        output_dir: é…ç½®æ–‡ä»¶è¾“å‡ºç›®å½•
    """
    # è¯»å–æ‰€æœ‰sheet
    excel_data = pd.read_excel(excel_file, sheet_name=None)
    
    # å°†sheetåä½œä¸ºè¡¨åï¼Œæ„å»ºcsv_fileså­—å…¸
    csv_files = {}
    temp_dir = Path(output_dir) / 'temp_csv'
    temp_dir.mkdir(parents=True, exist_ok=True)
    
    for sheet_name, df in excel_data.items():
        # ä¸´æ—¶ä¿å­˜ä¸ºCSV
        temp_csv = temp_dir / f"{sheet_name}.csv"
        df.to_csv(temp_csv, index=False)
        csv_files[sheet_name] = str(temp_csv)
    
    # è°ƒç”¨ä¹‹å‰çš„å‡½æ•°ç”Ÿæˆé…ç½®
    generate_catalog_from_csv(csv_files, output_dir)
    
    # æ¸…ç†ä¸´æ—¶CSVæ–‡ä»¶
    import shutil
    shutil.rmtree(temp_dir)
    print(f"\nå·²æ¸…ç†ä¸´æ—¶æ–‡ä»¶: {temp_dir}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    generate_catalog_from_excel(
        excel_file='data/business_data.xlsx',
        output_dir='./catalog_config'
    )
```

#### é…ç½®æ–‡ä»¶ä½¿ç”¨

ç”Ÿæˆé…ç½®æ–‡ä»¶åï¼Œåœ¨ `config.yaml` ä¸­é…ç½®ï¼š

```yaml
# ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿcatalogå­˜å‚¨
catalog_store:
  store_type: file_system
  data_path: ./catalog_config  # æŒ‡å‘ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ç›®å½•

# é…ç½®æ•°æ®ä»“åº“ï¼ˆä½¿ç”¨SQLiteï¼‰
data_warehouse_config:
  uri: "sqlite:///data/my_business.db"
  database_name: ""
```

æˆ–è€…ç›´æ¥ä½¿ç”¨CSVæ–‡ä»¶ï¼ˆé…åˆlocal_datasetsï¼‰ï¼š

```yaml
# ä½¿ç”¨æœ¬åœ°æ•°æ®é›†
local_datasets:
  - name: customers
    path: ./data/customers.csv
    description: å®¢æˆ·ä¿¡æ¯
    file_type: csv
  - name: orders
    path: ./data/orders.csv
    description: è®¢å•æ•°æ®
    file_type: csv
```

### 2. é€æ­¥å®Œå–„ä¸šåŠ¡ä¿¡æ¯

1. **ç¬¬ä¸€æ­¥**ï¼šå¡«å†™ `table_info.yaml` çš„ä¸šåŠ¡æè¿°
2. **ç¬¬äºŒæ­¥**ï¼šå®Œå–„ `common_columns.csv` çš„ä¸­æ–‡åç§°å’Œæè¿°
3. **ç¬¬ä¸‰æ­¥**ï¼šæ·»åŠ å…¸å‹SQLç¤ºä¾‹åˆ° `sql_example.yaml`
4. **ç¬¬å››æ­¥**ï¼šè¡¥å……è¡¨é€‰æ‹©ç¤ºä¾‹åˆ° `table_selection_example.csv`

### 3. ç»´æŠ¤æœ€ä½³å®è·µ

- **ç‰ˆæœ¬æ§åˆ¶**ï¼šå°†æ‰€æœ‰é…ç½®æ–‡ä»¶çº³å…¥ Git ç®¡ç†
- **å®šæœŸæ›´æ–°**ï¼šæ•°æ®åº“ç»“æ„å˜åŒ–æ—¶åŠæ—¶æ›´æ–°é…ç½®
- **å›¢é˜Ÿåä½œ**ï¼šå»ºç«‹é…ç½®æ–‡ä»¶è¯„å®¡æœºåˆ¶
- **æ–‡æ¡£åŒ–**ï¼šä¸ºå¤æ‚ä¸šåŠ¡è§„åˆ™æ·»åŠ è¯¦ç»†æ³¨é‡Š

---

## ğŸ“ è®¾è®¡åŸåˆ™

è¿™ç§è®¾è®¡ä½“ç°äº†ä»¥ä¸‹è½¯ä»¶å·¥ç¨‹åŸåˆ™ï¼š

1. **å…³æ³¨ç‚¹åˆ†ç¦»** (Separation of Concerns)
   - ç»“æ„ä¿¡æ¯ã€ä¸šåŠ¡è¯­ä¹‰ã€ç¤ºä¾‹å­¦ä¹ å„å¸å…¶èŒ

2. **DRYåŸåˆ™** (Don't Repeat Yourself)
   - é€šè¿‡ common_columns é¿å…é‡å¤å®šä¹‰

3. **å¼€é—­åŸåˆ™** (Open-Closed Principle)
   - é€šè¿‡ table_spec_columns æ‰©å±•è€Œéä¿®æ”¹

4. **æ‡’åŠ è½½** (Lazy Loading)
   - æŒ‰éœ€åŠ è½½ï¼Œæé«˜æ€§èƒ½

5. **ç¼“å­˜ä¼˜åŒ–** (Caching)
   - å‡å°‘é‡å¤IOæ“ä½œ

---

## ğŸ“š å‚è€ƒé¡¹ç›®ç¤ºä¾‹

é¡¹ç›®ä¸­æä¾›äº†ä¸¤ä¸ªå®Œæ•´ç¤ºä¾‹ï¼š

1. **example/** - ç®€å•è®¢å•è·Ÿè¸ªç³»ç»Ÿ
2. **data/sdtm/** - CDISC SDTMä¸´åºŠè¯•éªŒæ•°æ®

å¯ä»¥å‚è€ƒè¿™äº›ç›®å½•ä¸­çš„é…ç½®æ–‡ä»¶ä½œä¸ºæ¨¡æ¿ã€‚

---

**ç”Ÿæˆæ—¥æœŸ**: 2025-12-23  
**åŸºäºç‰ˆæœ¬**: file_system.py (790 lines)
